name: CI - Build, Test, Deploy with Kind

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root123
          MYSQL_DATABASE: taskmanagement
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Attendre MySQL
      - name: Wait for MySQL
        run: |
          sudo apt-get install -y mysql-client
          until mysql -h 127.0.0.1 -uroot -proot -e "SELECT 1"; do
            echo "Waiting for MySQL..."
            sleep 5
          done

      # 4Ô∏è‚É£ Build + tests (CI)
      - name: Build Maven project
        run: mvn clean install
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/taskmanagement
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: root

      # 5Ô∏è‚É£ Installer Kind
      - name: Set up Kind
        uses: helm/kind-action@v1.10.0

      # 6Ô∏è‚É£ Cr√©er cluster Kind
      - name: Create Kind cluster
        run: kind create cluster --name kind-ci --wait 5m

      # 7Ô∏è‚É£ Build image Docker
      - name: Build Docker image
        run: docker build -t devopsproject-backend:latest .

      # 8Ô∏è‚É£ Charger image dans Kind
      - name: Load Docker image into Kind
        run: kind load docker-image devopsproject-backend:latest --name kind-ci

      # 9Ô∏è‚É£ D√©ployer sur Kubernetes (CD)
      - name: Deploy to Kind
        run: kubectl apply -f K8s/

      # üîü V√©rifier les pods
      - name: Check Pods
        run: kubectl get pods -A
